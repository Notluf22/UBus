<!DOCTYPE html>
<html>
<head>
  <title>UBus - Selected Bus</title>
  <link rel="icon" href="logo-transparent-png.png" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { font-family: sans-serif; background: rgb(152, 166, 139); padding: 20px; }
    .bus-details { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; margin: 120px auto 0 auto; animation: slideUp 1s ease-out; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .bus-details h2 { font-size: 45px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .bus-details p { font-size: large; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 8px 0; }
    .button { background-color: green; color: white; padding: 10px 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; display: block; width: 60%; margin-left: 20%; }
    .button:hover { background-color: rgb(1, 70, 1); }
  </style>
</head>
<body>

<div class="bus-details" id="busDetails">
  <h2>Selected Bus</h2>
  <p>Loading bus information...</p>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://wztfguawfjvjuvkwairh.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6dGZndWF3Zmp2anV2a3dhaXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTc4OTAsImV4cCI6MjA3NjA5Mzg5MH0.3P2_rRQH4lcRyvzf00swTyte0bz68GSVSJjDobY8CsE"; // replace with your anon key
  const client = createClient(SUPABASE_URL, SUPABASE_KEY);

  const selectedBusId = sessionStorage.getItem("selectedBusId");
  console.log("Selected Bus ID:", selectedBusId);

  function toTitleCase(str) {
    return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : "N/A";
  }

  async function loadBusDetails() {
    const busDetailsDiv = document.getElementById("busDetails");
    busDetailsDiv.innerHTML = "<p>Loading bus information...</p>";

    if (!selectedBusId) {
      busDetailsDiv.innerHTML = "<p>No bus selected. Please go back and select a bus.</p>";
      return;
    }

    try {
      const { data: bus, error } = await client
        .from('buses')
        .select('*')
        .eq('bus_id', selectedBusId)
        .single();

      console.log("Fetched bus from Supabase:", bus, error);

      if (error || !bus) {
        busDetailsDiv.innerHTML = "<p>‚ö†Ô∏è Failed to load bus details. Check console for errors.</p>";
        return;
      }

      const source = bus.source || "N/A";
      const destination = bus.destination || "N/A";

      const rate = (bus.bus_type || "").toLowerCase() === "super fast" ? 15 :
                   (bus.bus_type || "").toLowerCase() === "fast" ? 12 : 10;
      const fare = bus.fare || rate; 

      busDetailsDiv.innerHTML = `
        <h2>${bus.bus_type || "Bus"} üöå</h2>
        <p><strong>Bus ID:</strong> ${bus.bus_id}</p>
        <p><strong>Route:</strong> ${toTitleCase(source)} ‚ûù ${toTitleCase(destination)}</p>
        <p><strong>Departure:</strong> ${bus.departure_time || "N/A"} from ${bus.boarding_point || "N/A"}</p>
        <p><strong>Arrival:</strong> ${bus.arrival_time || "N/A"} at ${bus.dropping_point || "N/A"}</p>
        <p><strong>Duration:</strong> ${bus.duration || "N/A"}</p>
        <p><strong>Fare:</strong> ‚Çπ${fare}</p>
        <button class="button" id="proceedBtn">Proceed to Booking</button>
      `;

      document.getElementById("proceedBtn").addEventListener("click", () => {
        window.location.href = "booking.html";
      });

    } catch (err) {
      console.error("Error loading bus:", err);
      busDetailsDiv.innerHTML = "<p>‚ö†Ô∏è Failed to load bus details.</p>";
    }
  }

  document.addEventListener("DOMContentLoaded", loadBusDetails);
</script>

</body>
</html>
