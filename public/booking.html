<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ✅ Your Supabase project details
  const SUPABASE_URL = "https://wztfguawfjvjuvkwairh.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6dGZndWF3Zmp2anV2a3dhaXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTc4OTAsImV4cCI6MjA3NjA5Mzg5MH0.3P2_rRQH4lcRyvzf00swTyte0bz68GSVSJjDobY8CsE";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function initBooking() {
    const selectedBusId = sessionStorage.getItem("selectedBusId");
    const farePerSeat = parseInt(sessionStorage.getItem("fare") || "0");
    const busInfoDiv = document.getElementById("busInfo");

    try {
      // ✅ Fetch all buses from Supabase
      const { data: buses, error } = await supabase.from("buses").select("*");
      if (error) throw error;

      const selectedBus = buses.find(bus => bus.id == selectedBusId);

      if (selectedBus) {
        busInfoDiv.innerHTML = `
          <p class="bus"><strong>Bus:</strong> ${selectedBus.busType}</p>
          <p class="from"><strong>From:</strong> ${selectedBus.from} ➝ <strong>To:</strong> ${selectedBus.to}</p>
          <p class="dep"><strong>Departure:</strong> ${selectedBus.departure_time || "N/A"}</p>
          <p class="arr"><strong>Arrival:</strong> ${selectedBus.arrival_time || "N/A"}</p>
          <p class="fare"><strong>Fare per seat:</strong> ₹${selectedBus.fare || farePerSeat}</p>
        `;

        document.getElementById("bookingForm").addEventListener("submit", (e) => {
          e.preventDefault();
          const confirmBox = document.getElementById("confirmationMsg");
          confirmBox.style.display = "flex";

          setTimeout(() => {
            window.location.href = "ticket.html";
          }, 1800);
        });
      } else {
        busInfoDiv.innerHTML = "<p>❌ Missing bus details. Please go back and try again.</p>";
        document.getElementById("bookingForm").style.display = "none";
      }
    } catch (error) {
      console.error("Error loading bus data:", error);
      busInfoDiv.innerHTML = "<p>⚠️ Unable to load bus data.</p>";
    }
  }

  window.addEventListener("DOMContentLoaded", initBooking);
</script>
