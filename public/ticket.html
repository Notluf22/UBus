<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Ticket - UBus</title>
<style>
  body { font-family: 'Poppins', sans-serif; background: rgb(152,166,139); padding: 30px; }
  .ticket-container { background: #fff; padding: 30px; border-radius: 15px; max-width: 650px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); animation: slideUp 0.5s ease-out; }
  @keyframes slideUp { from { transform: translateY(30px); opacity:0; } to { transform: translateY(0); opacity:1; } }
  h2 { text-align: center; font-size: 45px; margin-bottom: 20px; }
  .ticket-details p { margin: 8px 0; font-size: large; color: black; }
  .qr-section { margin-top: 25px; text-align: center; }
  .button-group { display: flex; gap: 10px; margin-top: 30px; }
  .download-btn, .back-btn { flex: 1; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 16px; border: none; color: white; background: green; transition: 0.3s; }
  .download-btn:hover, .back-btn:hover { background: rgb(1,70,1); }
</style>
</head>
<body>

<div id="ticket" class="ticket-container">
  <h2>üé´ UBus E-Ticket</h2>
  <div class="ticket-details" id="ticketDetails">
    <p>Loading ticket...</p>
  </div>
  <div class="qr-section">
    <canvas id="qrCode"></canvas>
  </div>
  <div class="button-group">
    <button class="download-btn" id="downloadBtn">Download PDF</button>
    <button class="back-btn" id="backBtn">‚Üê Back to Home</button>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import QRCode from "https://cdn.skypack.dev/qrcode";
  import html2pdf from "https://cdn.skypack.dev/html2pdf.js";

  const SUPABASE_URL = "https://wztfguawfjvjuvkwairh.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6dGZndWF3Zmp2anV2a3dhaXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTc4OTAsImV4cCI6MjA3NjA5Mzg5MH0.3P2_rRQH4lcRyvzf00swTyte0bz68GSVSJjDobY8CsE"; // Replace with your anon key
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadTicket() {
    const selectedBusId = sessionStorage.getItem("selectedBusId");
    const seats = parseInt(sessionStorage.getItem("seatsBooked") || 1);
    const passengerName = sessionStorage.getItem("passengerName") || "Passenger";
    const passengerEmail = sessionStorage.getItem("passengerEmail") || "N/A";
    const fare = parseInt(sessionStorage.getItem("fare") || 0);

    const ticketDiv = document.getElementById("ticketDetails");

    if (!selectedBusId) {
      ticketDiv.innerHTML = "<p>‚ùå No bus selected. Go back and select a bus.</p>";
      return;
    }

    try {
      const { data: bus, error } = await supabase
        .from('buses')
        .select('*')
        .eq('bus_id', selectedBusId)
        .single();

      console.log("Fetched bus:", bus, error); 

      if (error || !bus) {
        ticketDiv.innerHTML = "<p>‚ö†Ô∏è Unable to load bus details. Check console for errors.</p>";
        return;
      }

      const busType = bus.bus_type || bus.busType || "Unknown";
      const source = bus.source || bus.from || "Unknown";
      const destination = bus.destination || bus.to || "Unknown";
      const departure = bus.departure_time || "N/A";
      const arrival = bus.arrival_time || "N/A";
      const totalFare = (bus.fare || fare) * seats;

      ticketDiv.innerHTML = `
        <p><strong>Bus Type:</strong> ${busType} üöå</p>
        <p><strong>From:</strong> ${source}</p>
        <p><strong>To:</strong> ${destination}</p>
        <p><strong>Departure:</strong> ${departure}</p>
        <p><strong>Arrival:</strong> ${arrival}</p>
        <p><strong>Seats Booked:</strong> ${seats}</p>
        <p><strong>Total Fare:</strong> ‚Çπ${totalFare}</p>
        <p><strong>Passenger:</strong> ${passengerName}</p>
        <p><strong>Email:</strong> ${passengerEmail}</p>
      `;

      QRCode.toCanvas(document.getElementById('qrCode'),
        `UBus Ticket\nPassenger: ${passengerName}\nFrom: ${source} ‚ûù ${destination}\nSeats: ${seats}\nFare: ‚Çπ${totalFare}`,
        { width: 150 }, err => { if(err) console.error(err); }
      );

    } catch(err) {
      console.error(err);
      ticketDiv.innerHTML = "<p>‚ö†Ô∏è Error fetching ticket details. Check console.</p>";
    }
  }

  function downloadPDF() {
    const element = document.getElementById('ticket');
    html2pdf().from(element).save('UBus_Ticket.pdf');
  }

  document.getElementById("downloadBtn").addEventListener("click", downloadPDF);
  document.getElementById("backBtn").addEventListener("click", () => window.location.href="mainpage.html");

  document.addEventListener("DOMContentLoaded", loadTicket);
</script>

</body>
</html>
