<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UBus Results</title>
<link rel="stylesheet" href="results.css">
</head>
<body>
<div class="header-container">
  <button id="backBtn" class="back-button">‚Üê Back</button>
  <h2>Available Buses</h2>
  <div class="route-heading" id="routeHeading"></div>
</div>

<div class="results" id="results"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Supabase setup
  const SUPABASE_URL = "https://wztfguawfjvjuvkwairh.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6dGZndWF3Zmp2anV2a3dhaXJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTc4OTAsImV4cCI6MjA3NjA5Mzg5MH0.3P2_rRQH4lcRyvzf00swTyte0bz68GSVSJjDobY8CsE";

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const source = sessionStorage.getItem('source');
  const destination = sessionStorage.getItem('destination');

  if (!source || !destination) {
    alert("Missing search data. Redirecting...");
    window.location.href = "dashboard.html";
  }

  document.getElementById("routeHeading").textContent = `From ${source} to ${destination}`;
  document.getElementById("backBtn").addEventListener("click", () => history.back());

  async function loadBuses() {
    try {
      const { data: buses, error } = await supabase
        .from('buses')
        .select('*')
        .ilike('source', source)
        .ilike('destination', destination);

      if (error) throw error;

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = '';

      if (!buses || buses.length === 0) {
        resultsDiv.innerHTML = "<p>No buses found for this route.</p>";
        return;
      }

      buses.forEach(bus => {
        const busCard = document.createElement('div');
        busCard.classList.add('bus-card');
        busCard.innerHTML = `
          <strong>${bus.bus_type} üöå</strong><br>
          <div class="bus-id"><span>Bus ID:</span> ${bus.bus_id}</div>
          <div class="departure">Departure: ${bus.departure_time} ‚Üí Arrival: ${bus.arrival_time}</div>
          <div class="route">${bus.boarding_point} to ${bus.dropping_point}</div>
          <div class="fare">Fare: ‚Çπ${bus.fare}</div>
        `;
        const selectBtn = document.createElement('button');
        selectBtn.textContent = "Select";
        selectBtn.classList.add('select-btn');
        selectBtn.addEventListener('click', () => {
          sessionStorage.setItem('selectedBusId', bus.bus_id);
          window.location.href = 'select.html';
        });
        busCard.appendChild(selectBtn);
        resultsDiv.appendChild(busCard);
      });
    } catch (err) {
      console.error(err);
      document.getElementById("results").innerHTML = "<p>Failed to load buses.</p>";
    }
  }

  document.addEventListener('DOMContentLoaded', loadBuses);
</script>
</body>
</html>
